<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fiche PJ D&D 5e</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #58180D;
      --paper: #fdf1dc;
      --border: #d2b38c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background: #ddd;
      font-family: 'Crimson Pro', serif;
    }
    .app {
      max-width: 1100px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
    .icon-btn {
      border: 1px solid #c0b7aa;
      background: #fff7ec;
      color: var(--ink);
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
    }
    .icon-btn:hover { background: #f3e2c8; }
    .stat-block {
      background: var(--paper);
      border: 1px solid var(--border);
      box-shadow: 0 0 15px #aaa;
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/5/5f/Old_paper_texture_27.jpg');
      background-size: cover;
      padding: 20px;
      /* max-width: 1400px; */
      margin: 0 auto;
    }
    .row { display: flex; gap: 12px; }
    .col { flex: 1; }
    h1 {
      font-family: 'Cinzel', serif;
      font-size: 26px;
      text-transform: uppercase;
      color: var(--ink);
      margin: 0 0 8px;
    }
    .header-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px 10px;
      font-size: 12px;
    }
    .field-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #7a4b36;
    }
    .field-value {
      border-bottom: 1px solid #bda68a;
      min-height: 18px;
      padding: 0 2px 2px;
    }
    .field-value[contenteditable="true"] { outline: none; }
    .section-title {
      font-family: 'Cinzel', serif;
      font-size: 16px;
      color: var(--ink);
      margin: 10px 0 4px;
      border-bottom: 2px solid var(--ink);
      display: inline-block;
      padding-bottom: 2px;
    }
    .abilities {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 8px;
      margin-top: 6px;
    }
    .ability-block {
      border: 1px solid #c9b89c;
      background: rgba(255,255,255,0.35);
      padding: 4px 6px;
    }
    .ability-box {
      border: 1px solid #c9b89c;
      padding: 4px 6px;
      background: rgba(255,255,255,0.6);
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      font-size: 13px;
    }
    .ability-name {
      font-family: 'Cinzel', serif;
      color: var(--ink);
      font-size: 12px;
      text-transform: uppercase;
    }
    .ability-score {
      text-align: right;
      font-weight: 600;
    }
    .ability-score[contenteditable="true"] { outline: none; }
    .box {
      border: 1px solid #c9b89c;
      padding: 4px 6px;
      background: rgba(255,255,255,0.4);
      font-size: 12px;
      min-height: 20px;
    }
    .box[contenteditable="true"] { outline: none; }
    /* Placeholder styling for contenteditable fields */
    [contenteditable="true"].placeholder:empty:before,
    .field-value[contenteditable="true"].placeholder:empty:before {
      content: attr(data-placeholder);
      color: #7a4b36;
      opacity: 0.6;
      pointer-events: none;
    }
    .checks-group {
      margin-top: 4px;
      font-size: 11px;
    }
    .check-row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px;
    }
    .check-row span.label {
      flex: 1;
    }
    .check-row span.bonus {
      min-width: 30px;
      text-align: right;
      font-weight: 600;
    }
    .list-column {
      border: 1px solid #c9b89c;
      background: rgba(255,255,255,0.4);
      padding: 4px 6px;
      font-size: 11px;
      max-height: 260px;
      overflow-y: auto;
    }
    .list-item {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 1px;
    }
    .list-item input[type="checkbox"] {
      width: 10px;
      height: 10px;
    }
    .list-item span {
      flex: 1;
    }
    textarea.big {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      border: 1px solid #c9b89c;
      background: rgba(255,255,255,0.4);
      padding: 6px;
      font-family: 'Crimson Pro', serif;
      font-size: 12px;
      box-sizing: border-box;
    }
    /* Spellcasting styles (bottom section) */
    .spell-block { margin-top: 6px; }
    .slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap:8px; }
    .slot-card { border: 1px solid #c9b89c; background: rgba(255,255,255,0.45); padding:8px; font-size:13px; display:flex; align-items:center; gap:8px; }
    .slot-card input[type="number"]{ width:60px; padding:4px; border:1px solid #bda68a; background:transparent; }
    .spell-list .list-column { max-height: 340px; }
    .small-btn { padding:4px 6px; font-size:12px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="toolbar">
      <div>
        <button class="icon-btn" onclick="location.href='index.html'">⬅ Retour</button>
      </div>
      <div>
        <button id="exportPc" class="icon-btn">Exporter la fiche (JSON)</button>
        <button id="importPcBtn" class="icon-btn">Importer une fiche</button>
        <input id="importPcInput" type="file" accept="application/json" style="display:none">
        <button id="downloadPcPng" class="icon-btn">Télécharger en PNG</button>
      </div>
    </div>

    <div class="stat-block" id="pcSheet">
      <header>
        <h1 contenteditable="true" id="pcName" class="placeholder" data-placeholder="Nom du personnage"></h1>
        <div class="header-grid">
          <div>
            <div class="field-label">Classe & niveau</div>
            <div class="field-value placeholder" contenteditable="true" id="pcClassLevel" data-placeholder="Classe & niveau"></div>
          </div>
          <div>
            <div class="field-label">Passif/Profession</div>
            <div class="field-value placeholder" contenteditable="true" id="pcBackground" data-placeholder="Passif"></div>
          </div>
          <div>
            <div class="field-label">Race</div>
            <div class="field-value placeholder" contenteditable="true" id="pcRace" data-placeholder="Race"></div>
          </div>
          <div>
            <div class="field-label">Alignement</div>
            <div class="field-value placeholder" contenteditable="true" id="pcAlignment" data-placeholder="Alignement"></div>
          </div>
          <div>
            <div class="field-label">Points d'expérience</div>
            <div class="field-value placeholder" contenteditable="true" id="pcXP" data-placeholder="XP"></div>
          </div>
        </div>
      </header>

      <div class="row" style="margin-top:12px;">
        <div class="col" style="max-width: 280px;">
          <div class="section-title">Caractéristiques</div>
          <div class="row" style="margin-top:4px; align-items:center; gap:6px;">
            <div class="field-label">Bonus de maîtrise</div>
            <div class="box placeholder" contenteditable="true" id="pcProf" data-placeholder="+2" style="max-width:48px; text-align:center;"></div>
          </div>
          <div class="abilities" id="pcAbilities">
            <div class="ability-block" data-ability-block="str">
              <div class="ability-box"><div class="ability-name">FOR</div><div class="ability-score" data-ability="str" contenteditable="true">16 (+3)</div></div>
              <div class="checks-group" data-checks-for="str"></div>
            </div>
            <div class="ability-block" data-ability-block="dex">
              <div class="ability-box"><div class="ability-name">DEX</div><div class="ability-score" data-ability="dex" contenteditable="true">14 (+2)</div></div>
              <div class="checks-group" data-checks-for="dex"></div>
            </div>
            <div class="ability-block" data-ability-block="con">
              <div class="ability-box"><div class="ability-name">CON</div><div class="ability-score" data-ability="con" contenteditable="true">15 (+2)</div></div>
              <div class="checks-group" data-checks-for="con"></div>
            </div>
            <div class="ability-block" data-ability-block="int">
              <div class="ability-box"><div class="ability-name">INT</div><div class="ability-score" data-ability="int" contenteditable="true">10 (+0)</div></div>
              <div class="checks-group" data-checks-for="int"></div>
            </div>
            <div class="ability-block" data-ability-block="wis">
              <div class="ability-box"><div class="ability-name">SAG</div><div class="ability-score" data-ability="wis" contenteditable="true">12 (+1)</div></div>
              <div class="checks-group" data-checks-for="wis"></div>
            </div>
            <div class="ability-block" data-ability-block="cha">
              <div class="ability-box"><div class="ability-name">CHA</div><div class="ability-score" data-ability="cha" contenteditable="true">10 (+0)</div></div>
              <div class="checks-group" data-checks-for="cha"></div>
            </div>
          </div>
        </div>

        <div class="col">
          <div class="row">
            <div class="col">
              <div class="section-title">Combat</div>
              <div class="row" style="margin-top:4px;">
                <div class="col">
                  <div class="field-label">Classe d'armure</div>
                  <div class="box placeholder" contenteditable="true" id="pcAC" data-placeholder="CA"></div>
                </div>
                <div class="col">
                  <div class="field-label">Initiative</div>
                  <div class="box placeholder" contenteditable="true" id="pcInit" data-placeholder="+0"></div>
                </div>
                <div class="col">
                  <div class="field-label">Vitesse</div>
                  <div class="box placeholder" contenteditable="true" id="pcSpeed" data-placeholder="9 m"></div>
                </div>
              </div>
              <div class="row" style="margin-top:6px;">
                <div class="col">
                  <div class="field-label">Points de vie max.</div>
                  <div class="box placeholder" contenteditable="true" id="pcHPMax" data-placeholder="PV max."></div>
                </div>
                <div class="col">
                  <div class="field-label">PV actuels</div>
                  <div class="box placeholder" contenteditable="true" id="pcHPCurrent" data-placeholder="PV actuels"></div>
                </div>
                <div class="col">
                  <div class="field-label">Dés de vie</div>
                  <div class="box placeholder" contenteditable="true" id="pcHitDice" data-placeholder="3d10"></div>
                </div>
              </div>

              <div class="section-title">Attaques & sorts</div>
              <div style="display:grid;grid-template-columns:1.2fr 0.6fr 0.9fr 1.2fr auto;gap:4px;font-size:11px;margin:4px 0;">
                <div class="field-label">Nom</div>
                <div class="field-label">Bonus</div>
                <div class="field-label">Dégâts / type</div>
                <div class="field-label">Notes</div>
                <div class="field-label" style="text-align:center;">Suppr.</div>
              </div>
              <div id="pcAttacksList"></div>
              <button id="addAttack" class="icon-btn" style="margin-top:4px;">+ Ajouter une attaque / sort</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col">
              <div class="section-title">Traits & capacités</div>
              <div id="pcTraitsList"></div>
              <button id="addTrait" class="icon-btn" style="margin-top:4px;">+ Ajouter un trait / capacité</button>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col">
              <div class="section-title">Équipement & trésor</div>
              <textarea class="big" id="pcEquipment">Armure de plates, épée longue, arc long, 20 flèches, sac d'aventurier.</textarea>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col">
              <div class="section-title">Historique & notes</div>
              <textarea class="big" id="pcBackstory">Brève histoire, liens, objectifs...</textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

    <!-- Spellcasting section inserted at the bottom of the sheet -->
    <div class="stat-block spell-block" id="pcSpellcasting">
      <div class="section-title">Lancer de sorts</div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;">
        <div style="min-width:160px;">
          <div class="field-label">Caractéristique de lancer</div>
          <div class="box placeholder" contenteditable="true" id="pcSpellAbility" data-placeholder="Ex: CHA"></div>
        </div>
        <div style="min-width:140px;">
          <div class="field-label">DD du sort</div>
          <div class="box placeholder" contenteditable="true" id="pcSpellDC" data-placeholder="Ex: 13"></div>
        </div>
        <div style="min-width:160px;">
          <div class="field-label">Bonus d'attaque</div>
          <div class="box placeholder" contenteditable="true" id="pcSpellAtk" data-placeholder="Ex: +5"></div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="field-label">Sorts et emplacements par niveau</div>
        <div id="pcSpellsAndSlots" style="margin-top:8px;">
          <!-- per-level sections injected by JS: levels 0..9 -->
        </div>
      </div>
    </div>

  <script>
    // Load dom-to-image for PNG export
    (function loadDomToImage(){
      if (window.domtoimage) return;
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/dom-to-image@2.6.0/dist/dom-to-image.min.js';
      document.head.appendChild(s);
    })();

    const sheet = document.getElementById('pcSheet');

    const portraitFit = 'contain';

    // Saving throws & skills grouped by ability (from official 5e sheet, localized)
    const abilitiesOrder = ['str','dex','con','int','wis','cha'];
    const skillData = [
      { key: 'acrobatics', ability: 'dex', label: 'Acrobaties (DEX)' },
      { key: 'animalHandling', ability: 'wis', label: 'Dressage (SAG)' },
      { key: 'arcana', ability: 'int', label: 'Arcanes (INT)' },
      { key: 'athletics', ability: 'str', label: 'Athlétisme (FOR)' },
      { key: 'deception', ability: 'cha', label: 'Supercherie (CHA)' },
      { key: 'history', ability: 'int', label: 'Histoire (INT)' },
      { key: 'insight', ability: 'wis', label: 'Perspicacité (SAG)' },
      { key: 'intimidation', ability: 'cha', label: 'Intimidation (CHA)' },
      { key: 'investigation', ability: 'int', label: 'Investigation (INT)' },
      { key: 'medicine', ability: 'wis', label: 'Médecine (SAG)' },
      { key: 'nature', ability: 'int', label: 'Nature (INT)' },
      { key: 'perception', ability: 'wis', label: 'Perception (SAG)' },
      { key: 'performance', ability: 'cha', label: 'Représentation (CHA)' },
      { key: 'persuasion', ability: 'cha', label: 'Persuasion (CHA)' },
      { key: 'religion', ability: 'int', label: 'Religion (INT)' },
      { key: 'sleight', ability: 'dex', label: 'Escamotage (DEX)' },
      { key: 'stealth', ability: 'dex', label: 'Discrétion (DEX)' },
      { key: 'survival', ability: 'wis', label: 'Survie (SAG)' },
    ];

    const saveProf = {};
    const skillProf = {};

    // Ability auto-formatting
    const abilityEls = sheet.querySelectorAll('[data-ability]');
    function abilityMod(score) {
      const n = parseInt(score, 10);
      if (Number.isNaN(n)) return 0;
      return Math.floor((n - 10) / 2);
    }
    function normalizeAbility(el) {
      const raw = el.textContent || '';
      const num = parseInt(raw, 10);
      if (Number.isNaN(num)) return;
      const mod = abilityMod(num);
      const modTxt = `${mod >= 0 ? '+' : ''}${mod}`;
      el.textContent = `${num} (${modTxt})`;
    }
    abilityEls.forEach((el) => {
      el.addEventListener('blur', () => { normalizeAbility(el); renderChecks(); });
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); el.blur(); }
      });
      normalizeAbility(el);
    });

    function getProfBonus() {
      const raw = (document.getElementById('pcProf').textContent || '').replace('+','').trim();
      const n = parseInt(raw, 10);
      return Number.isNaN(n) ? 2 : n;
    }

    function getAbilityMod(key) {
      const el = sheet.querySelector(`[data-ability="${key}"]`);
      if (!el) return 0;
      const text = el.textContent || '';
      const num = parseInt(text, 10);
      return abilityMod(num);
    }

    function renderChecks() {
      const pb = getProfBonus();
      abilitiesOrder.forEach((ab) => {
        const container = sheet.querySelector(`.checks-group[data-checks-for="${ab}"]`);
        if (!container) return;
        container.innerHTML = '';
        const mod = getAbilityMod(ab);

        // Skills for this ability
        skillData.filter(s => s.ability === ab).forEach((sk) => {
          const row = document.createElement('div');
          row.className = 'check-row';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = !!skillProf[sk.key];
          cb.addEventListener('change', () => {
            skillProf[sk.key] = cb.checked;
            renderChecks();
          });
          const label = document.createElement('span');
          label.className = 'label';
          label.textContent = sk.label;
          const bonus = document.createElement('span');
          bonus.className = 'bonus';
          const val = mod + (skillProf[sk.key] ? pb : 0);
          bonus.textContent = `${val >= 0 ? '+' : ''}${val}`;
          row.appendChild(cb);
          row.appendChild(label);
          row.appendChild(bonus);
          container.appendChild(row);
        });
      });
    }

    document.getElementById('pcProf').addEventListener('blur', renderChecks);
    document.getElementById('pcProf').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); }
    });

    renderChecks();

    // JSON export/import
    const exportBtn = document.getElementById('exportPc');
    const importBtn = document.getElementById('importPcBtn');
    const importInput = document.getElementById('importPcInput');

    // Dynamic lists: attacks and traits
    const attacksContainer = document.getElementById('pcAttacksList');
    const addAttackBtn = document.getElementById('addAttack');
    const traitsContainer = document.getElementById('pcTraitsList');
    const addTraitBtn = document.getElementById('addTrait');

    let attacks = [];
    let traits = [];

    function renderAttacks() {
      attacksContainer.innerHTML = '';
      attacks.forEach((atk, idx) => {
        const row = document.createElement('div');
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '1.2fr 0.6fr 0.9fr 1.2fr auto';
        row.style.gap = '4px';
        row.style.alignItems = 'center';
        row.style.marginBottom = '4px';

        const name = document.createElement('div');
        name.className = 'box placeholder';
        name.contentEditable = 'true';
        name.dataset.placeholder = 'Nom';
        name.textContent = atk.name || '';
        name.addEventListener('input', (e) => { attacks[idx].name = e.target.textContent; });

        const bonus = document.createElement('div');
        bonus.className = 'box placeholder';
        bonus.contentEditable = 'true';
        bonus.dataset.placeholder = 'Bonus';
        bonus.textContent = atk.bonus || '';
        bonus.addEventListener('input', (e) => { attacks[idx].bonus = e.target.textContent; });

        const dmg = document.createElement('div');
        dmg.className = 'box placeholder';
        dmg.contentEditable = 'true';
        dmg.dataset.placeholder = '1d8+X type';
        dmg.textContent = atk.damage || '';
        dmg.addEventListener('input', (e) => { attacks[idx].damage = e.target.textContent; });

        const notes = document.createElement('div');
        notes.className = 'box placeholder';
        notes.contentEditable = 'true';
        notes.dataset.placeholder = 'Notes';
        notes.textContent = atk.notes || '';
        notes.addEventListener('input', (e) => { attacks[idx].notes = e.target.textContent; });

        const del = document.createElement('button');
        del.className = 'icon-btn';
        del.textContent = '×';
        del.title = 'Supprimer';
        del.addEventListener('click', (e) => {
          e.preventDefault();
          attacks.splice(idx, 1);
          renderAttacks();
        });

        row.appendChild(name);
        row.appendChild(bonus);
        row.appendChild(dmg);
        row.appendChild(notes);
        row.appendChild(del);
        attacksContainer.appendChild(row);
      });
    }

    function renderTraits() {
      traitsContainer.innerHTML = '';
      traits.forEach((tr, idx) => {
        const row = document.createElement('div');
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '0.8fr 1.4fr auto';
        row.style.gap = '4px';
        row.style.alignItems = 'center';
        row.style.marginBottom = '4px';

        const name = document.createElement('div');
        name.className = 'box placeholder';
        name.contentEditable = 'true';
        name.dataset.placeholder = 'Nom';
        name.textContent = tr.name || '';
        name.addEventListener('input', (e) => { traits[idx].name = e.target.textContent; });

        const notes = document.createElement('div');
        notes.className = 'box placeholder';
        notes.contentEditable = 'true';
        notes.dataset.placeholder = 'Notes';
        notes.textContent = tr.notes || '';
        notes.addEventListener('input', (e) => { traits[idx].notes = e.target.textContent; });

        const del = document.createElement('button');
        del.className = 'icon-btn';
        del.textContent = '×';
        del.title = 'Supprimer';
        del.addEventListener('click', (e) => {
          e.preventDefault();
          traits.splice(idx, 1);
          renderTraits();
        });

        row.appendChild(name);
        row.appendChild(notes);
        row.appendChild(del);
        traitsContainer.appendChild(row);
      });
    }

    addAttackBtn.addEventListener('click', (e) => {
      e.preventDefault();
      attacks.push({ name: '', bonus: '', damage: '', notes: '' });
      renderAttacks();
    });
    addTraitBtn.addEventListener('click', (e) => {
      e.preventDefault();
      traits.push({ name: '', notes: '' });
      renderTraits();
    });

    renderAttacks();
    renderTraits();

    function collectPcData() {
      const data = {
        name: document.getElementById('pcName').textContent,
        classLevel: document.getElementById('pcClassLevel').textContent,
        background: document.getElementById('pcBackground').textContent,
        race: document.getElementById('pcRace').textContent,
        alignment: document.getElementById('pcAlignment').textContent,
        xp: document.getElementById('pcXP').textContent,
        abilities: {},
        saves: saveProf,
        skills: skillProf,
        ac: document.getElementById('pcAC').textContent,
        init: document.getElementById('pcInit').textContent,
        speed: document.getElementById('pcSpeed').textContent,
        hpMax: document.getElementById('pcHPMax').textContent,
        hpCurrent: document.getElementById('pcHPCurrent').textContent,
        hitDice: document.getElementById('pcHitDice').textContent,
        attacks,
        traits,
        equipment: document.getElementById('pcEquipment').value,
        backstory: document.getElementById('pcBackstory').value,
        // spellcasting fields
        spellAbility: document.getElementById('pcSpellAbility') ? document.getElementById('pcSpellAbility').textContent : '',
        spellDC: document.getElementById('pcSpellDC') ? document.getElementById('pcSpellDC').textContent : '',
        spellAtk: document.getElementById('pcSpellAtk') ? document.getElementById('pcSpellAtk').textContent : '',
        spells: window._spells || [],
        spellSlots: window._spellSlots || {},
        // portrait: pcImage.src || '',
        // portraitState: { zoom, offsetX, offsetY },
      };
      abilityEls.forEach((el) => {
        const key = el.getAttribute('data-ability');
        data.abilities[key] = el.textContent;
      });
      return data;
    }

    function applyPcData(data) {
      if (!data) return;
      if (data.name) document.getElementById('pcName').textContent = data.name;
      if (data.classLevel) document.getElementById('pcClassLevel').textContent = data.classLevel;
      if (data.background) document.getElementById('pcBackground').textContent = data.background;
      if (data.player) document.getElementById('pcPlayer').textContent = data.player;
      if (data.race) document.getElementById('pcRace').textContent = data.race;
      if (data.alignment) document.getElementById('pcAlignment').textContent = data.alignment;
      if (data.xp) document.getElementById('pcXP').textContent = data.xp;
      if (data.abilities) {
        abilityEls.forEach((el) => {
          const key = el.getAttribute('data-ability');
          if (data.abilities[key]) el.textContent = data.abilities[key];
          normalizeAbility(el);
        });
      }
      Object.assign(saveProf, data.saves || {});
      Object.assign(skillProf, data.skills || {});
      renderChecks();
      if (data.ac) document.getElementById('pcAC').textContent = data.ac;
      if (data.init) document.getElementById('pcInit').textContent = data.init;
      if (data.speed) document.getElementById('pcSpeed').textContent = data.speed;
      if (data.hpMax) document.getElementById('pcHPMax').textContent = data.hpMax;
      if (data.hpCurrent) document.getElementById('pcHPCurrent').textContent = data.hpCurrent;
      if (data.hitDice) document.getElementById('pcHitDice').textContent = data.hitDice;
      if (Array.isArray(data.attacks)) { attacks = data.attacks; renderAttacks(); }
      if (Array.isArray(data.traits)) { traits = data.traits; renderTraits(); }
      if (data.equipment) document.getElementById('pcEquipment').value = data.equipment;
      if (data.backstory) document.getElementById('pcBackstory').value = data.backstory;
      // spellcasting fields are handled separately below if present when importing JSON
      // if (data.portrait) {
      //   pcImage.src = data.portrait;
      //   pcImage.style.display = 'block';
      //   deletePortraitBtn.disabled = false;
      //   zoom = data.portraitState?.zoom ?? 1;
      //   offsetX = data.portraitState?.offsetX ?? 0;
      //   offsetY = data.portraitState?.offsetY ?? 0;
      //   applyPortraitSizing();
      //   attachImageInteractions(pcImage);
      // } else {
      //   pcImage.src = '';
      //   pcImage.style.display = 'none';
      //   deletePortraitBtn.disabled = true;
      // }
    }

    exportBtn.addEventListener('click', () => {
      try {
        const data = collectPcData();
        const json = JSON.stringify(data, null, 2);
        const a = document.createElement('a');
        a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(json);
        a.download = 'fiche-pj.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (err) {
        console.error('Export error:', err);
        alert('Erreur lors de l\'export JSON: ' + err.message);
      }
    });

    importBtn.addEventListener('click', () => {
      importInput.click();
    });

    importInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          applyPcData(data);
          // Handle spellcasting
          if (data.spellAbility) document.getElementById('pcSpellAbility').textContent = data.spellAbility;
          if (data.spellDC) document.getElementById('pcSpellDC').textContent = data.spellDC;
          if (data.spellAtk) document.getElementById('pcSpellAtk').textContent = data.spellAtk;
          window._spells = data.spells || [];
          window._spellSlots = data.spellSlots || {};
          renderSpells();
        } catch (err) {
          console.error(err);
          alert('Fichier JSON invalide');
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    // PNG export
    const downloadBtn = document.getElementById('downloadPcPng');
    downloadBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!window.domtoimage) {
        alert('Chargement de dom-to-image... réessayez dans une seconde.');
        return;
      }
      downloadBtn.disabled = true;
      downloadBtn.textContent = 'Génération...';
      try {
        const dataUrl = await window.domtoimage.toPng(sheet, { bgcolor: null, scale: 4 });
        const link = document.createElement('a');
        link.download = 'fiche-pj.png';
        link.href = dataUrl;
        link.click();
      } catch (err) {
        console.error(err);
        alert('Erreur lors de la génération du PNG');
      } finally {
        downloadBtn.disabled = false;
        downloadBtn.textContent = 'Télécharger en PNG';
      }
    });

    // --- Spellcasting logic (spells, prepared, slots, persistence) ---
    window._spells = window._spells || [];
    window._spellSlots = window._spellSlots || (function(){
      const s = {};
      for (let i=1;i<=6;i++) s[i] = { total: 0, used: 0 };
      return s;
    })();

    function renderSpells() {
      const parent = document.getElementById('pcSpellsAndSlots');
      if (!parent) return;
      parent.innerHTML = '';
      for (let lvl = 0; lvl <= 6; lvl++) {
        const levelBlock = document.createElement('div');
        levelBlock.style.marginBottom = '12px';
        levelBlock.style.border = '1px solid #c9b89c';
        levelBlock.style.padding = '8px';
        levelBlock.style.background = 'rgba(255,255,255,0.4)';

        // Subtitle
        const subtitle = document.createElement('div');
        subtitle.className = 'section-title';
        subtitle.style.fontSize = '14px';
        subtitle.style.marginBottom = '6px';
        if (lvl === 0) {
          subtitle.textContent = 'Niveau 0 (Tour de magie / Cantrips)';
        } else {
          subtitle.textContent = `Niveau ${lvl}`;
        }
        levelBlock.appendChild(subtitle);

        // Slot info for levels 1-9: X / Y fields
        if (lvl >= 1) {
          const slotInfo = document.createElement('div');
          slotInfo.style.display = 'flex';
          slotInfo.style.gap = '4px';
          slotInfo.style.alignItems = 'center';
          slotInfo.style.marginBottom = '6px';

          const slotLabel = document.createElement('span');
          slotLabel.textContent = "Nombre d'utilisation: ";
          slotLabel.style.fontSize = '12px';
          slotLabel.style.marginRight = '4px';

          const usedDisplay = document.createElement('span');
          usedDisplay.textContent = (window._spellSlots[lvl] && window._spellSlots[lvl].used) || 0;
          usedDisplay.style.minWidth = '20px';
          usedDisplay.style.textAlign = 'center';

          const minusBtn = document.createElement('button');
          minusBtn.className = 'icon-btn small-btn';
          minusBtn.textContent = '-';
          minusBtn.addEventListener('click', () => {
            window._spellSlots[lvl].used = Math.max(0, window._spellSlots[lvl].used - 1);
            usedDisplay.textContent = window._spellSlots[lvl].used;
            renderSpells();
            savePcToLocal();
          });

          const plusBtn = document.createElement('button');
          plusBtn.className = 'icon-btn small-btn';
          plusBtn.textContent = '+';
          plusBtn.addEventListener('click', () => {
            window._spellSlots[lvl].used = Math.min(window._spellSlots[lvl].total, window._spellSlots[lvl].used + 1);
            usedDisplay.textContent = window._spellSlots[lvl].used;
            renderSpells();
            savePcToLocal();
          });

          const slash = document.createTextNode(' / ');

          const totalInput = document.createElement('input');
          totalInput.type = 'number';
          totalInput.min = 0;
          totalInput.value = (window._spellSlots[lvl] && window._spellSlots[lvl].total) || 0;
          totalInput.style.width = '50px';
          totalInput.addEventListener('change', () => {
            window._spellSlots[lvl].total = Math.max(0, parseInt(totalInput.value) || 0);
            if (window._spellSlots[lvl].used > window._spellSlots[lvl].total) {
              window._spellSlots[lvl].used = window._spellSlots[lvl].total;
              usedDisplay.textContent = window._spellSlots[lvl].used;
            }
            renderSpells();
            savePcToLocal();
          });

          slotInfo.appendChild(slotLabel);
          slotInfo.appendChild(minusBtn);
          slotInfo.appendChild(usedDisplay);
          slotInfo.appendChild(plusBtn);
          slotInfo.appendChild(slash);
          slotInfo.appendChild(totalInput);
          levelBlock.appendChild(slotInfo);
        }

        // Spell list headers
        const headers = document.createElement('div');
        headers.style.display = 'grid';
        headers.style.gridTemplateColumns = '40px 1fr 60px 1fr auto';
        headers.style.gap = '6px';
        headers.style.fontSize = '11px';
        headers.style.marginBottom = '6px';
        headers.innerHTML = '<div class="field-label">Préparé</div><div class="field-label">Nom</div><div class="field-label">Niv.</div><div class="field-label">Notes</div><div class="field-label" style="text-align:center;">Suppr.</div>';
        levelBlock.appendChild(headers);

        // Spell list
        const spellList = document.createElement('div');
        spellList.className = 'list-column';
        spellList.style.maxHeight = '200px'; // limit height
        (window._spells || []).forEach((sp, idx) => {
          const spLevel = (sp.level === undefined || sp.level === null) ? '' : String(sp.level).trim();
          if (String(lvl) === spLevel) {
            const row = document.createElement('div');
            row.className = 'list-item';
            row.style.display = 'grid';
            row.style.gridTemplateColumns = '40px 1fr 60px 1fr auto';
            row.style.alignItems = 'center';
            row.style.gap = '6px';

            const prep = document.createElement('input');
            prep.type = 'checkbox';
            prep.checked = !!sp.prepared;
            prep.addEventListener('change', () => { window._spells[idx].prepared = prep.checked; savePcToLocal(); });

            const name = document.createElement('div');
            name.className = 'box placeholder';
            name.contentEditable = 'true';
            name.dataset.placeholder = 'Nom du sort';
            name.textContent = sp.name || '';
            name.addEventListener('input', (e) => { window._spells[idx].name = e.target.textContent; savePcToLocal(); });

            const levelEl = document.createElement('div');
            levelEl.className = 'box';
            levelEl.style.textAlign = 'center';
            levelEl.textContent = sp.level || '';
            levelEl.addEventListener('input', (e) => { window._spells[idx].level = e.target.textContent; savePcToLocal(); renderSpells(); });

            const notes = document.createElement('div');
            notes.className = 'box placeholder';
            notes.contentEditable = 'true';
            notes.dataset.placeholder = 'Notes';
            notes.textContent = sp.notes || '';
            notes.addEventListener('input', (e) => { window._spells[idx].notes = e.target.textContent; savePcToLocal(); });

            const del = document.createElement('button');
            del.className = 'icon-btn small-btn';
            del.textContent = '×';
            del.title = 'Supprimer';
            del.addEventListener('click', () => { window._spells.splice(idx,1); renderSpells(); savePcToLocal(); });

            row.appendChild(prep);
            row.appendChild(name);
            row.appendChild(levelEl);
            row.appendChild(notes);
            row.appendChild(del);
            spellList.appendChild(row);
          }
        });

        // Add spell button
        const addBtn = document.createElement('button');
        addBtn.className = 'icon-btn small-btn';
        addBtn.textContent = '+ Ajouter sort';
        addBtn.addEventListener('click', () => { window._spells.push({ name: '', level: String(lvl), notes: '', prepared: false }); renderSpells(); savePcToLocal(); });

        levelBlock.appendChild(spellList);
        levelBlock.appendChild(addBtn);
        parent.appendChild(levelBlock);
      }
    }



    function savePcToLocal() {
      try {
        const data = collectPcData();
        // also store spells/slots explicitly
        data.spells = window._spells;
        data.spellSlots = window._spellSlots;
        localStorage.setItem('pcData', JSON.stringify(data));
      } catch (err) { console.error('Save failed', err); }
    }

    function loadPcFromLocal() {
      try {
        const raw = localStorage.getItem('pcData');
        if (!raw) return;
        const data = JSON.parse(raw);
        applyPcData(data);
      } catch (err) { console.error('Load failed', err); }
    }

    // Apply any spell data already present (if import applied earlier, call will be idempotent)
    renderSpells();
    loadPcFromLocal();
  </script>
</body>
</html>


